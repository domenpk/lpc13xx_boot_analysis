{"name":"LPC13xx boot analysis","tagline":"LPC13xx Bootloader Reverse Engineering","body":"LPC13xx Bootloader Reverse Engineering\r\n======================================\r\n\r\nThis article describes my research into internals of bootloader on NXP's lpc1313 and lpc1343 chips.\r\n\r\nWhat is it?\r\n-----------\r\nBootloader on lpc13xx chips is located in internal ROM at `0x1fff0000` and is `0x4000` (16kB) in size. It contains code for:\r\n - Checksum validation, CRP handling and handover to user code.\r\n - UART bootloader\r\n - USB bootloader\r\n - IAP routines\r\n\r\nExisting work\r\n-------------\r\nNone that I'm aware of. Googling for undocumented peripheral registers,\r\nvalues, addresses returns no results or something completely unrelated.\r\n\r\nMy work\r\n-------\r\nI've used simple utilities to dump the FLASH contents to serial, and then transform to binaries objdump could understand.\r\n\r\nThe attached disassembly is from lpc1313, although it also contains USB code, so I think it's safe to assume the bootloader is shared amongst different chips.\r\n\r\nBootloader is using quite a few undocumented peripheral registers and\r\ncurrently what stands out the most for me is the secret FLASH described below.\r\n\r\nThe CRP checks look simple enough and don't seem to contain logic bugs. I do\r\nwonder how SWD is handled (is it disabled soon after boot, which would be bad\r\nfrom security point of view, or does it have to be enabled?)\r\n\r\nSecret FLASH area\r\n-----------------\r\nWhen disassembling I've noticed some special accesses are taking place.\r\n\r\nIt appears `0x0000` area can be remapped to some secret flash, if you write\r\nenable bit `0x40` at location `0x4003c000` (undocumented address, although close\r\nto other FLASH settings):\r\n```\r\nunsigned *f = (unsigned*)0x4003c000;\r\n*f |= 0x40;\r\n```\r\n\r\nNote that since this code will basically make user FLASH unreachable, it\r\nshould be executed from RAM.\r\n\r\nThis secret FLASH area is 2k long, with most entries being `0xffffffff`. It\r\ncontains some settings that are used by the bootloader and has a description\r\nof FLASH sectors. Accessing beyond 2k of this region just starts returning the same contents over and over again.\r\n\r\nTODO\r\n----\r\n - What are differences between lpc131x and lpc134x chips? Is it possible USB is just disabled? Compare bootloader dumps and secret flash dumps.\r\n - Can secret FLASH be changed?\r\n - Where is SWD enabled/disabled?\r\n - Create short code (binary even?) to easily dump contents of different chips\r\n   and start building a database of bootloaders and special FLASH areas.\r\n - What's ISP's \"T\" command?\r\n\r\n\r\nExtra resources:\r\n----------------\r\n - [objdump with comments](boot_disassembly.txt)\r\n - [secret FLASH dump with comments](secret_flash_lpc1313.txt)\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}